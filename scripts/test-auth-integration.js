#!/usr/bin/env node

/**
 * Script completo para testar funcionalidades de autentica√ß√£o Supabase
 */

require('dotenv').config();
const axios = require('axios');

const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
};

const log = {
  info: (msg) => console.log(`${colors.blue}‚Ñπ ${msg}${colors.reset}`),
  success: (msg) => console.log(`${colors.green}‚úÖ ${msg}${colors.reset}`),
  error: (msg) => console.log(`${colors.red}‚ùå ${msg}${colors.reset}`),
  warning: (msg) => console.log(`${colors.yellow}‚ö†Ô∏è  ${msg}${colors.reset}`),
  test: (msg) => console.log(`${colors.cyan}üß™ ${msg}${colors.reset}`),
};

const BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000';
const API_URL = `${BASE_URL}/api/auth`;

// Dados de teste
const testUser = {
  email: `test-${Date.now()}@example.com`,
  password: 'Test123456',
  full_name: 'Usu√°rio de Teste',
  phone: '11999999999',
};

let authTokens = {
  access_token: null,
  refresh_token: null,
};

/**
 * Fun√ß√£o auxiliar para fazer requisi√ß√µes HTTP
 */
async function makeRequest(method, endpoint, data = null, headers = {}) {
  try {
    const config = {
      method,
      url: `${API_URL}${endpoint}`,
      headers: {
        'Content-Type': 'application/json',
        ...headers,
      },
    };

    if (data) {
      config.data = data;
    }

    const response = await axios(config);
    return { success: true, data: response.data, status: response.status };
  } catch (error) {
    return {
      success: false,
      error: error.response?.data || error.message,
      status: error.response?.status || 500,
    };
  }
}

/**
 * Teste 1: Registro de usu√°rio
 */
async function testUserRegistration() {
  log.test('Testando registro de usu√°rio...');

  const result = await makeRequest('POST', '/register', testUser);

  if (result.success) {
    log.success('Usu√°rio registrado com sucesso');
    log.info(`ID do usu√°rio: ${result.data.user.id}`);
    log.info(`Email: ${result.data.user.email}`);
    return true;
  } else {
    log.error(`Falha no registro: ${result.error.error || result.error}`);
    return false;
  }
}

/**
 * Teste 2: Login do usu√°rio
 */
async function testUserLogin() {
  log.test('Testando login do usu√°rio...');

  const result = await makeRequest('POST', '/login', {
    email: testUser.email,
    password: testUser.password,
  });

  if (result.success && result.data.tokens) {
    authTokens.access_token = result.data.tokens.access_token;
    authTokens.refresh_token = result.data.tokens.refresh_token;

    log.success('Login realizado com sucesso');
    log.info(`Token obtido: ${authTokens.access_token.substring(0, 50)}...`);
    return true;
  } else {
    log.error(`Falha no login: ${result.error.error || result.error}`);
    return false;
  }
}

/**
 * Teste 3: Obter perfil do usu√°rio
 */
async function testGetProfile() {
  log.test('Testando obten√ß√£o do perfil...');

  if (!authTokens.access_token) {
    log.error('Token de acesso n√£o dispon√≠vel');
    return false;
  }

  const result = await makeRequest('GET', '/profile', null, {
    Authorization: `Bearer ${authTokens.access_token}`,
  });

  if (result.success) {
    log.success('Perfil obtido com sucesso');
    log.info(`Nome: ${result.data.user.metadata?.full_name || 'N/A'}`);
    log.info(
      `Email verificado: ${result.data.user.email_verified ? 'Sim' : 'N√£o'}`
    );
    return true;
  } else {
    log.error(`Falha ao obter perfil: ${result.error.error || result.error}`);
    return false;
  }
}

/**
 * Teste 4: Atualizar perfil
 */
async function testUpdateProfile() {
  log.test('Testando atualiza√ß√£o do perfil...');

  if (!authTokens.access_token) {
    log.error('Token de acesso n√£o dispon√≠vel');
    return false;
  }

  const updates = {
    full_name: 'Nome Atualizado',
    phone: '11888888888',
  };

  const result = await makeRequest('PUT', '/profile', updates, {
    Authorization: `Bearer ${authTokens.access_token}`,
  });

  if (result.success) {
    log.success('Perfil atualizado com sucesso');
    return true;
  } else {
    log.error(
      `Falha ao atualizar perfil: ${result.error.error || result.error}`
    );
    return false;
  }
}

/**
 * Teste 5: Refresh token
 */
async function testRefreshToken() {
  log.test('Testando renova√ß√£o do token...');

  if (!authTokens.refresh_token) {
    log.error('Refresh token n√£o dispon√≠vel');
    return false;
  }

  const result = await makeRequest('POST', '/refresh-token', {
    refresh_token: authTokens.refresh_token,
  });

  if (result.success && result.data.tokens) {
    const oldToken = authTokens.access_token.substring(0, 20);
    authTokens.access_token = result.data.tokens.access_token;
    authTokens.refresh_token = result.data.tokens.refresh_token;

    log.success('Token renovado com sucesso');
    log.info(`Token anterior: ${oldToken}...`);
    log.info(`Novo token: ${authTokens.access_token.substring(0, 20)}...`);
    return true;
  } else {
    log.error(`Falha na renova√ß√£o: ${result.error.error || result.error}`);
    return false;
  }
}

/**
 * Teste 6: Status de autentica√ß√£o
 */
async function testAuthStatus() {
  log.test('Testando status de autentica√ß√£o...');

  // Teste sem token
  let result = await makeRequest('GET', '/status');

  if (result.success && result.data.authenticated === false) {
    log.success('Status sem autentica√ß√£o: OK');
  } else {
    log.warning('Status sem autentica√ß√£o inesperado');
  }

  // Teste com token
  if (authTokens.access_token) {
    result = await makeRequest('GET', '/status', null, {
      Authorization: `Bearer ${authTokens.access_token}`,
    });

    if (result.success && result.data.authenticated === true) {
      log.success('Status com autentica√ß√£o: OK');
      log.info(`Usu√°rio autenticado: ${result.data.user.email}`);
      return true;
    } else {
      log.error('Status com autentica√ß√£o falhou');
      return false;
    }
  }

  return true;
}

/**
 * Teste 7: Reset de senha
 */
async function testPasswordReset() {
  log.test('Testando reset de senha...');

  const result = await makeRequest('POST', '/reset-password', {
    email: testUser.email,
  });

  if (result.success) {
    log.success('Reset de senha solicitado com sucesso');
    return true;
  } else {
    log.error(`Falha no reset: ${result.error.error || result.error}`);
    return false;
  }
}

/**
 * Teste 8: Valida√ß√£o de dados inv√°lidos
 */
async function testInvalidData() {
  log.test('Testando valida√ß√£o de dados inv√°lidos...');

  // Teste registro com email inv√°lido
  let result = await makeRequest('POST', '/register', {
    email: 'email-invalido',
    password: '123',
  });

  if (!result.success && result.status === 400) {
    log.success('Valida√ß√£o de email inv√°lido: OK');
  } else {
    log.warning('Valida√ß√£o de email deveria falhar');
  }

  // Teste login sem dados
  result = await makeRequest('POST', '/login', {});

  if (!result.success && result.status === 400) {
    log.success('Valida√ß√£o de login sem dados: OK');
    return true;
  } else {
    log.warning('Valida√ß√£o de login vazia deveria falhar');
    return false;
  }
}

/**
 * Teste 9: Acesso com token inv√°lido
 */
async function testInvalidToken() {
  log.test('Testando acesso com token inv√°lido...');

  const result = await makeRequest('GET', '/profile', null, {
    Authorization: 'Bearer token-invalido-123',
  });

  if (!result.success && result.status === 403) {
    log.success('Rejei√ß√£o de token inv√°lido: OK');
    return true;
  } else {
    log.error('Token inv√°lido deveria ser rejeitado');
    return false;
  }
}

/**
 * Executar todos os testes
 */
async function runAllTests() {
  console.log(
    colors.magenta + 'üöÄ TESTES DE AUTENTICA√á√ÉO SUPABASE' + colors.reset
  );
  console.log('='.repeat(60));

  const tests = [
    { name: 'Registro de Usu√°rio', test: testUserRegistration },
    { name: 'Login do Usu√°rio', test: testUserLogin },
    { name: 'Obter Perfil', test: testGetProfile },
    { name: 'Atualizar Perfil', test: testUpdateProfile },
    { name: 'Renovar Token', test: testRefreshToken },
    { name: 'Status de Autentica√ß√£o', test: testAuthStatus },
    { name: 'Reset de Senha', test: testPasswordReset },
    { name: 'Valida√ß√£o de Dados', test: testInvalidData },
    { name: 'Token Inv√°lido', test: testInvalidToken },
  ];

  const results = [];

  for (const { name, test } of tests) {
    console.log('\n' + '-'.repeat(40));
    try {
      const result = await test();
      results.push({ name, status: result ? 'PASSOU' : 'FALHOU' });
    } catch (error) {
      log.error(`Erro no teste ${name}: ${error.message}`);
      results.push({ name, status: 'ERRO' });
    }
  }

  // Resumo final
  console.log('\n' + '='.repeat(60));
  console.log(
    colors.magenta + 'üìã RESUMO DOS TESTES DE AUTENTICA√á√ÉO' + colors.reset
  );
  console.log('='.repeat(60));

  const passed = results.filter((r) => r.status === 'PASSOU').length;
  const total = results.length;

  results.forEach((result) => {
    const icon =
      result.status === 'PASSOU'
        ? '‚úÖ'
        : result.status === 'FALHOU'
        ? '‚ùå'
        : '‚ö†Ô∏è';
    console.log(`${icon} ${result.name.padEnd(25)} ${result.status}`);
  });

  console.log('\n' + '-'.repeat(60));
  const percentage = Math.round((passed / total) * 100);
  const statusColor =
    percentage >= 80
      ? colors.green
      : percentage >= 50
      ? colors.yellow
      : colors.red;
  console.log(
    `${statusColor}üìä Taxa de Sucesso: ${passed}/${total} (${percentage}%)${colors.reset}`
  );

  if (percentage >= 80) {
    console.log(
      `${colors.green}üéâ Sistema de autentica√ß√£o est√° funcionando bem!${colors.reset}`
    );
  } else if (percentage >= 50) {
    console.log(
      `${colors.yellow}‚ö†Ô∏è  Sistema parcialmente funcional. Alguns ajustes necess√°rios.${colors.reset}`
    );
  } else {
    console.log(
      `${colors.red}üîß Sistema precisa de corre√ß√µes significativas.${colors.reset}`
    );
  }

  console.log(
    '\n' + colors.blue + '‚Ñπ Dados do usu√°rio de teste:' + colors.reset
  );
  console.log(`üìß Email: ${testUser.email}`);
  console.log(`üîë Senha: ${testUser.password}`);

  console.log('\n' + '='.repeat(60));
}

// Verificar se o servidor est√° rodando
async function checkServer() {
  try {
    const response = await axios.get(`${BASE_URL}/health`);
    return response.status === 200;
  } catch (error) {
    return false;
  }
}

// Executar testes se chamado diretamente
if (require.main === module) {
  const main = async () => {
    log.info(`Verificando servidor em ${BASE_URL}...`);

    const serverRunning = await checkServer();
    if (!serverRunning) {
      log.error(`Servidor n√£o est√° respondendo em ${BASE_URL}`);
      log.info('Certifique-se de que o servidor est√° rodando com: npm run dev');
      process.exit(1);
    }

    log.success('Servidor est√° respondendo');
    await runAllTests();
  };

  main().catch((error) => {
    log.error(`Erro geral: ${error.message}`);
    process.exit(1);
  });
}

module.exports = {
  testUserRegistration,
  testUserLogin,
  testGetProfile,
  testUpdateProfile,
  testRefreshToken,
  testAuthStatus,
  testPasswordReset,
  runAllTests,
};
